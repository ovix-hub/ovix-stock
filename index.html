<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OvixParts3D - Stock Relevamiento</title>
<style>
:root {
  --bg-light: #f5f6fa;
  --bg-dark: #1f1f1f;
  --text-light: #1e1e1e;
  --text-dark: #f0f0f0;
  --accent: #00adb5;
  --accent-hover: #06b9c5;
  --card-light: #ffffff;
  --card-dark: #2a2a2a;
  --shadow: 0 2px 8px rgba(0,0,0,0.1);
  --divider: rgba(0,173,181,0.25);
}

body {
  font-family: "Inter", sans-serif;
  margin: 0;
  background: var(--bg-light);
  color: var(--text-light);
  transition: background 0.3s, color 0.3s;
}
body.dark { background: var(--bg-dark); color: var(--text-dark); }

.container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
.header { text-align: center; margin-bottom: 1rem; }
.header img { width: 280px; transition: filter 0.3s; }
body.dark .header img { filter: invert(1); }
.header h1 { color: var(--accent); margin: 0.3rem 0; }
.header h2 { font-weight: normal; color: gray; margin-top: 0; }
.divider { width: 80%; height: 1px; background: var(--divider); margin: 0 auto 1.5rem; }

.btn {
  border: none; border-radius: 6px;
  padding: 0.5rem 1rem; cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  font-size: 0.9rem;
}
.btn.primary { background: var(--accent); color: #fff; }
.btn.primary:hover { background: var(--accent-hover); transform: scale(1.04); }
.btn.secondary {
  background: transparent; border: 1px solid var(--accent); color: var(--accent);
}
.btn.secondary:hover { background: rgba(0,173,181,0.08); }

.form-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem; margin-bottom: 1rem;
}
label { font-size: 0.85rem; font-weight: 500; display: block; margin-bottom: 4px; }
input, select {
  width: 100%; padding: 0.6rem; border: 1px solid #ccc; border-radius: 6px;
  font-size: 0.9rem; box-sizing: border-box;
}
input:focus, select:focus {
  outline: none; border-color: var(--accent);
  box-shadow: 0 0 4px rgba(0,173,181,0.3);
}

.small-note { font-size: 0.8rem; color: gray; margin-top: 6px; }

table {
  width: 100%; border-collapse: collapse; margin-top: 1rem;
  background: var(--card-light); border-radius: 6px; box-shadow: var(--shadow);
  overflow: hidden;
}
body.dark table { background: var(--card-dark); }
th { background: var(--accent); color: white; font-weight: 600; }
th, td { padding: 0.7rem; text-align: center; border-bottom: 1px solid #ccc; }
tr:hover { background: rgba(0,173,181,0.05); }
body.dark tr:hover { background: rgba(255,255,255,0.05); }

.catalog {
  margin-top: 2rem; padding: 1.2rem; border-radius: 8px;
  background: var(--card-light); box-shadow: var(--shadow);
  position: relative;
}
body.dark .catalog { background: var(--card-dark); }
#catalogCount { position: absolute; top: 10px; right: 15px; font-size: 0.85rem; color: gray; }
#catalogList li { padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
body.dark #catalogList li { border-color: rgba(255,255,255,0.1); }

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 0.75rem;
  border: 1px solid rgba(0,173,181,0.35);
  color: var(--accent);
  margin-right: 8px;
}

footer {
  text-align: center; color: #888; margin-top: 2rem;
  border-top: 1px solid var(--divider); padding-top: 1rem; font-size: 0.9rem;
}
body.dark footer { color: #bbb; border-color: rgba(255,255,255,0.2); }

.hidden { display: none !important; }
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <img src="ovix-logo.png" alt="Ovix Logo" />
    <h1>OvixParts3D</h1>
    <h2>Relevamiento de Stock ‚Äì by Ovix</h2>
    <button id="themeToggle" class="btn primary">üåó Modo</button>
  </div>
  <div class="divider"></div>

  <!-- ====== FORMULARIO PRINCIPAL ====== -->
  <form id="stockForm" class="form-grid">
    <div>
      <label>Categor√≠a</label>
      <select id="category" required>
        <option value="">Seleccionar...</option>
      </select>
      <div class="small-note">Primero eleg√≠ el c√≥digo (ACC, ELC, etc.).</div>
    </div>

    <div>
      <label>Pieza</label>
      <select id="pieceSelect" required disabled>
        <option value="">Seleccionar categor√≠a primero...</option>
      </select>
      <div class="small-note">Filtrado por categor√≠a. Pod√©s elegir ‚ÄúOtro‚Äù.</div>
    </div>

    <div id="customPieceWrap" class="hidden">
      <label>Nombre de pieza (Otro)</label>
      <input id="customPiece" placeholder="Ej: torn-m5x40" />
      <div class="small-note">Se guarda en el cat√°logo con la categor√≠a elegida.</div>
    </div>

    <div><label>Material</label><input list="materialList" id="material" /></div>
    <div><label>Color a imprimir</label><input list="colorList" id="colorPrint" /></div>
    <div><label>Cantidad a imprimir</label><input type="number" id="qtyPrint" min="0" /></div>
    <div><label>Color en stock</label><input list="colorList" id="colorStock" /></div>
    <div><label>Cantidad en stock</label><input type="number" id="qtyStock" min="0" /></div>

    <div>
      <label>Estado</label>
      <select id="status" required>
        <option value="">Seleccionar...</option>
        <option value="OK">OK</option>
        <option value="Reponer">Reponer</option>
      </select>
    </div>

    <div><label>Impresora</label><input list="printerList" id="printer" /></div>
    <div><label>Observaciones</label><input id="observaciones" /></div>

    <div style="align-self: end;">
      <button type="submit" class="btn primary" id="submitBtn">‚ûï Agregar</button>
    </div>
  </form>

  <datalist id="materialList"><option value="PLA"><option value="ABS"><option value="PETG"><option value="FLEX"></datalist>
  <datalist id="colorList"><option value="Negro"><option value="Blanco"><option value="Aqua"><option value="Rosa"><option value="Violeta"><option value="Multicolor"><option value="Natural"><option value="Otro"></datalist>
  <datalist id="printerList"><option value="Prusa Mini"><option value="Prusa MK3"><option value="Ender 3 S1 Pro"><option value="Ender 3 V3 Plus"><option value="Ender 3 V2"><option value="CR10 SPRO"><option value="CR10 MAX"><option value="K1C"></datalist>

  <table>
    <thead>
      <tr>
        <th>Cat</th><th>Pieza</th><th>Material</th><th>Color Imp</th><th>Cant Imp</th>
        <th>Color Stk</th><th>Cant Stk</th><th>Estado</th><th>Impresora</th><th>Fecha</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody id="stockBody"></tbody>
  </table>

  <!-- ====== EXPORTACI√ìN ====== -->
  <div style="margin-top:1.5rem;">
    <button id="exportStockBtn" class="btn secondary">üì§ Exportar stock</button>
    <button id="exportCatalogBtn" class="btn secondary">üì§ Exportar cat√°logo</button>
    <button id="exportTextBtn" class="btn secondary">üí¨ Exportar texto</button>
  </div>

  <!-- ====== CAT√ÅLOGO ====== -->
  <div class="catalog">
    <h2>üì¶ Cat√°logo de Piezas</h2><span id="catalogCount"></span>

    <form id="catalogForm" class="form-grid">
      <div>
        <label>Categor√≠a</label>
        <select id="newPieceCat" required>
          <option value="">Seleccionar...</option>
        </select>
      </div>
      <div>
        <label>Nueva pieza</label>
        <input type="text" id="newPieceName" required placeholder="Ej: motor-775" />
      </div>
      <div style="align-self:end;">
        <button type="submit" class="btn primary">‚ûï Agregar</button>
      </div>
      <div style="align-self:end;">
        <button type="button" id="resetCatalogBtn" class="btn secondary">üîÑ Resetear cat√°logo</button>
      </div>
    </form>

    <div><label>Buscar</label><input type="text" id="searchCatalog" placeholder="Buscar por c√≥digo o nombre..." /></div>
    <ul id="catalogList"></ul>
  </div>

  <footer>¬© 2026 Ovix ‚Äî porque contar stock a mano es una forma rara de sufrir</footer>
</div>

<script>
// === MODO OSCURO ===
const themeToggle = document.getElementById("themeToggle");
const body = document.body;
if (localStorage.getItem("theme") === "dark") body.classList.add("dark");
themeToggle.addEventListener("click", () => {
  body.classList.toggle("dark");
  localStorage.setItem("theme", body.classList.contains("dark") ? "dark" : "light");
});

// === REFERENCIAS FORM STOCK ===
const form = document.getElementById("stockForm");
const stockBody = document.getElementById("stockBody");
const submitBtn = document.getElementById("submitBtn");

const categorySel = document.getElementById("category");
const pieceSelect = document.getElementById("pieceSelect");
const customPieceWrap = document.getElementById("customPieceWrap");
const customPieceInput = document.getElementById("customPiece");

const material = document.getElementById("material");
const colorPrint = document.getElementById("colorPrint");
const qtyPrint = document.getElementById("qtyPrint");
const colorStock = document.getElementById("colorStock");
const qtyStock = document.getElementById("qtyStock");
const statusSel = document.getElementById("status");
const printer = document.getElementById("printer");
const observaciones = document.getElementById("observaciones");

// === CATEGOR√çAS ===
const CATEGORIES = [
  { code: "ACC", label: "ACC - Accesorios" },
  { code: "ELC", label: "ELC - El√©ctrico/Electr√≥nica" },
  { code: "EMP", label: "EMP - Embalaje" },
  { code: "IMP", label: "IMP - Impresi√≥n 3D" },
  { code: "LAS", label: "LAS - Corte L√°ser" },
  { code: "MEC", label: "MEC - Mec√°nica" },
  { code: "TOR", label: "TOR - Torniller√≠a/Fijaciones" },
];

// Carga selects de categor√≠as (stock y cat√°logo)
function populateCategorySelect(selectEl) {
  selectEl.innerHTML = `<option value="">Seleccionar...</option>`;
  CATEGORIES.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.code;
    opt.textContent = c.label;
    selectEl.appendChild(opt);
  });
}
populateCategorySelect(categorySel);
populateCategorySelect(document.getElementById("newPieceCat"));

// === CAT√ÅLOGO (ahora con categor√≠a + nombre) ===
const defaultCatalog = [
  { cat: "ACC", name: "oring-236" },
  { cat: "ACC", name: "oring-259" },
  { cat: "ACC", name: "oring-212" },
  { cat: "ACC", name: "prensa-g60" },
  { cat: "ACC", name: "perf-alum-mk11" },
  { cat: "ACC", name: "base-madera-mkm" },
  { cat: "ACC", name: "resorte-10mm" },
  { cat: "ACC", name: "pintura-base" },

  { cat: "ELC", name: "motor-775" },
  { cat: "ELC", name: "pwm-control" },
  { cat: "ELC", name: "fuente-12v7a" },
  { cat: "ELC", name: "contador-yf16" },
  { cat: "ELC", name: "sensor-njk" },
  { cat: "ELC", name: "jackdc-panel" },
  { cat: "ELC", name: "fusiblera-5x20" },
  { cat: "ELC", name: "Interruptor 12v" },
  { cat: "ELC", name: "fusible-4a" },
  { cat: "ELC", name: "cables-1x1" },

  { cat: "EMP", name: "caja-embalaje-mk9" },
  { cat: "EMP", name: "caja-embalaje-mkm" },
  { cat: "EMP", name: "plast-burbuja" },
  { cat: "EMP", name: "film" },

  { cat: "IMP", name: "base-conducida-mk" },
  { cat: "IMP", name: "base-husillo-mk" },
  { cat: "IMP", name: "brazo-mk" },
  { cat: "IMP", name: "contrapeso-mkm" },
  { cat: "IMP", name: "disco-45-mk" },
  { cat: "IMP", name: "husillo-mkm" },
  { cat: "IMP", name: "manibela-mkm" },
  { cat: "IMP", name: "patas-mkm" },
  { cat: "IMP", name: "polea-motor" },
  { cat: "IMP", name: "sop-prensahilo-mk" },
  { cat: "IMP", name: "sop-guia-mkm" },
  { cat: "IMP", name: "cono-49-mk" },
  { cat: "IMP", name: "contrapeso-mk9" },
  { cat: "IMP", name: "espa-07mm" },
  { cat: "IMP", name: "espa-4mm" },
  { cat: "IMP", name: "espa-6mm" },
  { cat: "IMP", name: "gabinete-mk9" },
  { cat: "IMP", name: "perilla-ajuste-mk" },
  { cat: "IMP", name: "polea-mkm" },
  { cat: "IMP", name: "resorte" },
  { cat: "IMP", name: "rulo-bronce" },
  { cat: "IMP", name: "sop-guia-mk9" },
  { cat: "IMP", name: "tapon-m8corto-mkm" },
  { cat: "IMP", name: "sop-totora-mk7" },
  { cat: "IMP", name: "tapon-m8largo-mkm" },

  { cat: "LAS", name: "corte-laser-mk9" },

  { cat: "MEC", name: "rod-606" },
  { cat: "MEC", name: "rod-608" },

  { cat: "TOR", name: "torn-m5x60" },
  { cat: "TOR", name: "torn-m5x30" },
  { cat: "TOR", name: "torn-ale-m5x20" },
  { cat: "TOR", name: "torn-ale-m6x65" },
  { cat: "TOR", name: "escuadra-sc25" },
  { cat: "TOR", name: "pyton-5" },
  { cat: "TOR", name: "tuerca-m3" },
  { cat: "TOR", name: "tuerca-m5" },
  { cat: "TOR", name: "tuerca-m5auto" },
  { cat: "TOR", name: "tuerca-m6" },
  { cat: "TOR", name: "tuerca-m6auto" },
  { cat: "TOR", name: "tuerca-m8" },
  { cat: "TOR", name: "tuerca-m8auto" },
  { cat: "TOR", name: "parker-8mm" },
  { cat: "TOR", name: "parker-19mm" },
  { cat: "TOR", name: "parker-6mm" },
  { cat: "TOR", name: "hojal-bronce" },
  { cat: "TOR", name: "torn-cil-m3x30" },
  { cat: "TOR", name: "torn-cil-m3x15" },
  { cat: "TOR", name: "torn-cil-m3x10" },
  { cat: "TOR", name: "torn-ale-m8x55" },
  { cat: "TOR", name: "torn-ale-m8x20" },
  { cat: "TOR", name: "grower-m5" },
  { cat: "TOR", name: "arand-m8" },
  { cat: "TOR", name: "varilla-m8" },
  { cat: "TOR", name: "prision-m5x10" },

  // extras del listado que sumaste al final
  { cat: "IMP", name: "puntales-mk11" },
  { cat: "IMP", name: "gabinete-mk11" },
  { cat: "IMP", name: "tapones-alu-mk11" },
];

function normalizeCatalogItem(x) {
  // Permite migrar desde el formato viejo (["pieza1","pieza2"]) si existiera en alg√∫n celu
  if (typeof x === "string") return { cat: "IMP", name: x }; // fallback decente
  return { cat: (x.cat || "").trim(), name: (x.name || "").trim() };
}

let catalog = (() => {
  const raw = JSON.parse(localStorage.getItem("catalog")) || null;
  if (!raw) return [...defaultCatalog];
  const migrated = raw.map(normalizeCatalogItem).filter(i => i.cat && i.name);
  // si est√° vac√≠o por corrupci√≥n, volvemos a default
  return migrated.length ? migrated : [...defaultCatalog];
})();

const catalogList = document.getElementById("catalogList");
const catalogCount = document.getElementById("catalogCount");

// Render cat√°logo (lista)
function renderCatalog(filter = "") {
  const f = filter.trim().toLowerCase();
  catalogList.innerHTML = "";

  const visible = catalog
    .filter(i => {
      const hay = `${i.cat} ${i.name}`.toLowerCase();
      return hay.includes(f);
    })
    .sort((a, b) => (a.cat + a.name).localeCompare(b.cat + b.name));

  visible.forEach(i => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="badge">${i.cat}</span>${escapeHtml(i.name)}`;
    catalogList.appendChild(li);
  });

  catalogCount.textContent = `${catalog.length} piezas registradas`;
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

function persistCatalog() {
  localStorage.setItem("catalog", JSON.stringify(catalog));
}

// === SELECT PIEZAS FILTRADO POR CATEGOR√çA ===
function getPiecesByCategory(cat) {
  return catalog
    .filter(i => i.cat === cat)
    .map(i => i.name)
    .sort((a, b) => a.localeCompare(b));
}

function renderPieceSelect(cat) {
  pieceSelect.innerHTML = "";
  customPieceWrap.classList.add("hidden");
  customPieceInput.value = "";

  if (!cat) {
    pieceSelect.disabled = true;
    pieceSelect.innerHTML = `<option value="">Seleccionar categor√≠a primero...</option>`;
    return;
  }

  const pieces = getPiecesByCategory(cat);
  pieceSelect.disabled = false;

  const opt0 = document.createElement("option");
  opt0.value = "";
  opt0.textContent = "Seleccionar...";
  pieceSelect.appendChild(opt0);

  pieces.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = p;
    pieceSelect.appendChild(opt);
  });

  const other = document.createElement("option");
  other.value = "__OTHER__";
  other.textContent = "‚úçÔ∏è Otro (escribir)";
  pieceSelect.appendChild(other);
}

categorySel.addEventListener("change", () => {
  renderPieceSelect(categorySel.value);
});

pieceSelect.addEventListener("change", () => {
  if (pieceSelect.value === "__OTHER__") {
    customPieceWrap.classList.remove("hidden");
    customPieceInput.focus();
  } else {
    customPieceWrap.classList.add("hidden");
    customPieceInput.value = "";
  }
});

// === CAT√ÅLOGO: agregar item ===
document.getElementById("catalogForm").addEventListener("submit", e => {
  e.preventDefault();
  const cat = document.getElementById("newPieceCat").value;
  const name = document.getElementById("newPieceName").value.trim();

  if (!cat) return alert("Eleg√≠ una categor√≠a.");
  if (!name) return alert("Ingres√° una pieza.");

  const exists = catalog.some(i => i.cat === cat && i.name.toLowerCase() === name.toLowerCase());
  if (!exists) {
    catalog.push({ cat, name });
    persistCatalog();
    renderCatalog(document.getElementById("searchCatalog").value);
    // si est√° seleccionada esa categor√≠a en el form principal, refrescamos piezas
    if (categorySel.value === cat) renderPieceSelect(cat);
  }
  e.target.reset();
});

document.getElementById("resetCatalogBtn").addEventListener("click", () => {
  if (confirm("¬øResetear cat√°logo al listado base? Esto borra agregados.")) {
    catalog = [...defaultCatalog];
    persistCatalog();
    renderCatalog();
    if (categorySel.value) renderPieceSelect(categorySel.value);
  }
});

document.getElementById("searchCatalog").addEventListener("input", e => renderCatalog(e.target.value));

// === STOCK ===
let stockData = JSON.parse(localStorage.getItem("stockData")) || [];
let editIndex = null;

function renderTable() {
  stockBody.innerHTML = "";
  stockData.forEach((item, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
<td>${escapeHtml(item.category || "")}</td>
<td>${escapeHtml(item.name)}</td>
<td>${escapeHtml(item.material)}</td>
<td>${escapeHtml(item.colorPrint)}</td>
<td>${item.qtyPrint}</td>
<td>${escapeHtml(item.colorStock)}</td>
<td>${item.qtyStock}</td>
<td>${escapeHtml(item.status)}</td>
<td>${escapeHtml(item.printer)}</td>
<td>${escapeHtml(item.date)}</td>
<td>
  <button onclick="verDetalle(${i})" class='btn secondary'>üîç</button>
  <button onclick="editarItem(${i})" class='btn secondary'>‚úèÔ∏è</button>
  <button onclick="deleteItem(${i})" class='btn secondary'>‚ùå</button>
</td>`;
    stockBody.appendChild(row);
  });
}

window.verDetalle = i => {
  const item = stockData[i];
  alert(`üì¶ Pieza: ${item.name}
üè∑Ô∏è Categor√≠a: ${item.category || "-"}
Material: ${item.material}
Color impresi√≥n: ${item.colorPrint}
Color stock: ${item.colorStock}
Cant. impresa: ${item.qtyPrint}
Cant. stock: ${item.qtyStock}
Estado: ${item.status}
Impresora: ${item.printer}
Fecha: ${item.date}
Observaciones: ${item.observaciones || "Sin observaciones"}`);
};

window.editarItem = i => {
  const item = stockData[i];
  editIndex = i;

  categorySel.value = item.category || "";
  renderPieceSelect(categorySel.value);

  // set pieza
  const existsInSelect = Array.from(pieceSelect.options).some(o => o.value === item.name);
  if (existsInSelect) {
    pieceSelect.value = item.name;
    customPieceWrap.classList.add("hidden");
    customPieceInput.value = "";
  } else {
    pieceSelect.value = "__OTHER__";
    customPieceWrap.classList.remove("hidden");
    customPieceInput.value = item.name;
  }

  material.value = item.material;
  colorPrint.value = item.colorPrint;
  qtyPrint.value = item.qtyPrint;
  colorStock.value = item.colorStock;
  qtyStock.value = item.qtyStock;
  statusSel.value = item.status;
  printer.value = item.printer;
  observaciones.value = item.observaciones || "";
  submitBtn.textContent = "üíæ Guardar";
};

window.deleteItem = i => {
  if (confirm("¬øEliminar este registro?")) {
    stockData.splice(i, 1);
    localStorage.setItem("stockData", JSON.stringify(stockData));
    renderTable();
  }
};

function ensureCatalogContains(cat, name) {
  const exists = catalog.some(i => i.cat === cat && i.name.toLowerCase() === name.toLowerCase());
  if (!exists) {
    catalog.push({ cat, name });
    persistCatalog();
    renderCatalog(document.getElementById("searchCatalog").value);
    if (categorySel.value === cat) renderPieceSelect(cat);
  }
}

form.addEventListener("submit", e => {
  e.preventDefault();

  const category = categorySel.value;
  if (!category) return alert("Seleccion√° una categor√≠a.");

  let pieceName = pieceSelect.value;
  if (!pieceName) return alert("Seleccion√° una pieza.");

  if (pieceName === "__OTHER__") {
    pieceName = customPieceInput.value.trim();
    if (!pieceName) return alert("Escrib√≠ el nombre de la pieza.");
    // al guardar stock, tambi√©n la agregamos al cat√°logo autom√°ticamente
    ensureCatalogContains(category, pieceName);
  }

  const item = {
    category,
    name: pieceName,
    material: material.value.trim(),
    colorPrint: colorPrint.value.trim(),
    qtyPrint: +qtyPrint.value || 0,
    colorStock: colorStock.value.trim(),
    qtyStock: +qtyStock.value || 0,
    status: statusSel.value,
    printer: printer.value.trim(),
    observaciones: observaciones.value.trim(),
    date: new Date().toLocaleDateString("es-AR")
  };

  if (!item.status) return alert("Debe seleccionar un estado.");

  if (editIndex !== null) {
    stockData[editIndex] = item;
    editIndex = null;
    submitBtn.textContent = "‚ûï Agregar";
  } else {
    stockData.push(item);
  }

  localStorage.setItem("stockData", JSON.stringify(stockData));
  form.reset();
  pieceSelect.disabled = true;
  pieceSelect.innerHTML = `<option value="">Seleccionar categor√≠a primero...</option>`;
  customPieceWrap.classList.add("hidden");
  customPieceInput.value = "";
  renderTable();
});

// === EXPORTAR CSV ===
function exportCSV(filename, data) {
  if (!data || data.length === 0) return alert("No hay datos para exportar.");

  const csvRows = [];
  const headers = Object.keys(data[0]);
  csvRows.push(headers.join(","));
  for (const row of data) {
    const values = headers.map(h => `"${String(row[h] ?? "").replace(/"/g, '""')}"`);
    csvRows.push(values.join(","));
  }
  const blob = new Blob([csvRows.join("\n")], { type: "text/csv" });
  const file = new File([blob], filename, { type: "text/csv" });

  if (navigator.share) {
    navigator.share({
      title: filename,
      text: "Archivo exportado desde OvixParts3D",
      files: [file]
    }).catch(console.error);
  } else {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }
}

// === EXPORTAR TEXTO ===
function exportText() {
  if (stockData.length === 0) return alert("No hay datos para exportar.");
  const fecha = new Date().toLocaleDateString("es-AR");
  const texto = stockData.map(item =>
`üì¶ ${item.name} (${item.category || "-"})
Material: ${item.material}
Estado: ${item.status}
Stock: ${item.qtyStock} u.
Color stock: ${item.colorStock}
Impresora: ${item.printer}
üïì ${item.date}
${item.observaciones ? "üìù " + item.observaciones : ""}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`
  ).join("\n");

  if (navigator.share) {
    navigator.share({
      title: `Stock Ovix ${fecha}`,
      text: texto
    }).catch(console.error);
  } else {
    navigator.clipboard.writeText(texto);
    alert("Texto copiado al portapapeles ‚úÖ");
  }
}

// === BOTONES EXPORTACI√ìN ===
document.getElementById("exportStockBtn").addEventListener("click", () => {
  exportCSV(`stock-ovix-${new Date().toLocaleDateString("es-AR")}.csv`, stockData);
});
document.getElementById("exportCatalogBtn").addEventListener("click", () => {
  const catalogData = catalog
    .slice()
    .sort((a,b) => (a.cat + a.name).localeCompare(b.cat + b.name))
    .map(i => ({ categoria: i.cat, pieza: i.name }));
  exportCSV(`catalogo-ovix-${new Date().toLocaleDateString("es-AR")}.csv`, catalogData);
});
document.getElementById("exportTextBtn").addEventListener("click", exportText);

// === INICIO ===
renderCatalog();
renderPieceSelect(""); // inicial
renderTable();
</script>
</body>
</html>